var V=Object.defineProperty;var B=(s,e,t)=>e in s?V(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>(B(s,typeof e!="symbol"?e+"":e,t),t);import"./modulepreload-polyfill-3cfb730f.js";import{r as m,ah as x,ak as D,f as G,ac as H,e as b,P,aa as _,af as E,V as F,G as k,B as A,h as j,b as M,a as z}from"./mapSource-2c762b60.js";import{g as U}from"./lil-gui.module.min-a1e98589.js";import{c as Z,a as I,i as N,s as K,b as O}from"./util-e741174c.js";class R{constructor(e,t=32){this.isLut=!0,this.lut=[],this.map=[],this.n=0,this.minV=0,this.maxV=1,this.setColorMap(e,t)}set(e){return e.isLut===!0&&this.copy(e),this}setMin(e){return this.minV=e,this}setMax(e){return this.maxV=e,this}setColorMap(e,t=32){this.map=w[e]||w.rainbow,this.n=t;const o=1/this.n,r=new m,h=new m;this.lut.length=0,this.lut.push(new m(this.map[0][1]));for(let c=1;c<t;c++){const n=c*o;for(let i=0;i<this.map.length-1;i++)if(n>this.map[i][0]&&n<=this.map[i+1][0]){const l=this.map[i][0],p=this.map[i+1][0];r.setHex(this.map[i][1],x),h.setHex(this.map[i+1][1],x);const d=new m().lerpColors(r,h,(n-l)/(p-l));this.lut.push(d)}}return this.lut.push(new m(this.map[this.map.length-1][1])),this}copy(e){return this.lut=e.lut,this.map=e.map,this.n=e.n,this.minV=e.minV,this.maxV=e.maxV,this}getColor(e){e=D.clamp(e,this.minV,this.maxV),e=(e-this.minV)/(this.maxV-this.minV);const t=Math.round(e*this.n);return this.lut[t]}addColorMap(e,t){return w[e]=t,this}createCanvas(){const e=document.createElement("canvas");return e.width=1,e.height=this.n,this.updateCanvas(e),e}updateCanvas(e){const t=e.getContext("2d",{alpha:!1}),o=t.getImageData(0,0,1,this.n),r=o.data;let h=0;const c=1/this.n,n=new m,i=new m,l=new m;for(let p=1;p>=0;p-=c)for(let d=this.map.length-1;d>=0;d--)if(p<this.map[d][0]&&p>=this.map[d-1][0]){const C=this.map[d-1][0],L=this.map[d][0];n.setHex(this.map[d-1][1],x),i.setHex(this.map[d][1],x),l.lerpColors(n,i,(p-C)/(L-C)),r[h*4]=Math.round(l.r*255),r[h*4+1]=Math.round(l.g*255),r[h*4+2]=Math.round(l.b*255),r[h*4+3]=255,h+=1}return t.putImageData(o,0,0),e}}const w={rainbow:[[0,255],[.2,65535],[.5,65280],[.8,16776960],[1,16711680]],cooltowarm:[[0,3952322],[.2,10206463],[.5,14474460],[.8,16163717],[1,11797542]],blackbody:[[0,0],[.2,7864320],[.5,15086080],[.8,16776960],[1,16777215]],grayscale:[[0,0],[.2,4210752],[.5,8355712],[.8,12566463],[1,16777215]]};function q(s={scale:1}){const e=new G({transparent:!0,vertexColors:!0,opacity:.6,side:H,displacementScale:s.scale});return e.onBeforeCompile=t=>{t.vertexShader=`varying vec3 vPosition;
            `+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <fog_vertex>",`
                #include <fog_vertex>
                vPosition = position;
                // transformed += normalize( objectNormal ) * ( texture2D(map, vUv ).a * displacementScale + displacementBias );
            `),t.fragmentShader=`varying vec3 vPosition;
            `+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",`
                #include <dithering_fragment>
                float h = vPosition.z;

                // 等值线
                float step = h*20.0 ; // 分析20条等值线
                float f  = fract(step);// 小数部分
                float width = fwidth(step);// 相邻像素的差
                float aa = smoothstep(width, width/1.1, f);//两个值之间插值
                float inv = 1.0 - aa;
                if(inv<1.0){
                    gl_FragColor = vec4(0.0,0.0,0.3,1.0);
                }
            `)},e}class J extends b{constructor(t){super();a(this,"_hScale",5);a(this,"width",1);a(this,"height",1);a(this,"data",[]);a(this,"max",-999999);a(this,"min",999999);a(this,"material",q());t&&this.setData(t)}setData(t){var o;return this.width=t[0].length,this.height=t.length,this.data=t.flat(),this.max=Math.max(...this.data),this.min=Math.min(...this.data),(o=this.geometry)==null||o.dispose(),this.geometry=new P(1,1,this.width-1,this.height-1),this.hScale=1,this}get hScale(){return this._hScale}set hScale(t){this._hScale=t;const o=this.geometry.attributes.position,r=[];let h=new R("rainbow",512);h.setMax(100),h.setMin(0);for(let c=0,n=o.count;c<n;c++){const i=(this.data[c]-this.min)/(this.max-this.min);o.setZ(c,i*t);const l=h.getColor(i*100);r.push(l.r,l.g,l.b)}this.geometry.setAttribute("color",new _(r,3)),this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.geometry.attributes.position.needsUpdate=!0}}async function Q(s){const e=await new E().loadAsync(s);return W(e)}class T{constructor(){a(this,"diamond","");a(this,"type",4);a(this,"name","");a(this,"year",2e3);a(this,"month",1);a(this,"day",1);a(this,"hour",0);a(this,"span",0);a(this,"level",0);a(this,"lonSpan",1);a(this,"latSpan",1);a(this,"beginLon",-180);a(this,"endLon",180);a(this,"beginLat",-90);a(this,"endLat",90);a(this,"countLon",360);a(this,"countLat",180);a(this,"levelSpan",10);a(this,"levelBegin",0);a(this,"levelEnd",100);a(this,"smoothingCoefficient",0);a(this,"boldValue",0)}}function W(s){const e=s.split(/[\s+\n+]+/),t=new T;let o=0;const r=t;for(let n in t)r[n]=typeof r[n]=="number"?parseFloat(e[o]):e[o],o++;if(t.diamond!="diamond"||t.type!=4)throw"无法解析数据文件，不是Micaps第4类文件格式";const h=[];for(let n=t.levelBegin;n<=t.levelEnd;n+=t.levelSpan)h.push(n);const c=new Array(t.countLat);for(let n=0;n<t.countLat;n++){let i=new Array(t.countLon);for(let l=0;l<t.countLon;l++)i[l]=parseFloat(e[o++]);c[n]=i}return{data:c,head:t,levels:h}}const u=Z([z]),S=u.geo2pos(new F(105,34)),X=new F(S.x,S.y,0),Y=new F(0,-5e3,1e4),g=I("#map",X,Y);g.scene.add(u);g.scene.background=new m(0);g.scene.background=new m(0);u.addEventListener("tile-loaded",s=>{s.tile.material.forEach(e=>{var t;return(t=e.color)==null?void 0:t.set(new m(8947848))})});const f=((s,e)=>{const t=new k;t.applyMatrix4(N(u,s,e,1)),t.scale.setZ(200),t.translateZ(100),t.renderOrder=10;const o=new b(new A),r=new j(o,16711935);return t.add(r),t})(new M(67,11),new M(140,57)),v=(()=>{const s=new J;return Q("../data/md4/10112608.000").then(e=>{s.setData(e.data),console.log(e.data)}),s.scale.setZ(.5),s})();f.add(v);g.scene.add(f);const $=new U,y=$.addFolder("500hpa高度场");y.add(f.scale,"z",100,1e3,1).name("垂直拉伸").onChange(s=>f.position.z=s/2);y.add(v.material,"opacity",.1,1,.1).name("透明度");y.add(v.material,"wireframe").name("网格");K(g,u);O(u);
