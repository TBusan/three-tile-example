var y=Object.defineProperty;var P=(i,s,t)=>s in i?y(i,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[s]=t;var n=(i,s,t)=>(P(i,typeof s!="symbol"?s+"":s,t),t);import"./modulepreload-polyfill-3cfb730f.js";import{g as v}from"./lil-gui.module.min-a1e98589.js";import{O as D,E as S,o as z,W as C,p as f,q as E,r as _,s as A,n as u,F as x,t as F,V as b,T as M,ab as I,I as R,a0 as k,ac as B,a6 as T,ad as j,ae as O}from"./three.module-31477d3d.js";import{c as X,b as Z,s as q}from"./util-f3e58d78.js";import{m as G,a as U}from"./mapSource-de628f72.js";import{M as V}from"./MapControls-154e80bf.js";import{S as W}from"./stats.module-8826aad6.js";D.DEFAULT_UP.set(0,0,1);class Y extends S{constructor(t,e){super();n(this,"scene",new z);n(this,"renderer",new C({antialias:!0,logarithmicDepthBuffer:!0}));n(this,"camera",new f(50,1,.1,1e3));n(this,"controls");n(this,"ambLight",new E(16777215,0));n(this,"dirLight",new _(16777215,0));n(this,"container");n(this,"flash",!0);n(this,"rain",!0);n(this,"_stats",new W);n(this,"_clock",new A);this.container=t,this.renderer.sortObjects=!1,this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement);const o=0;this.scene.background=new u(o),this.scene.fog=new x(o),this.camera=new f(50,1,.1,1e3),this.camera.position.set(e.x,e.y-30,e.z),this.scene.add(this.ambLight),this.dirLight.target.position.set(0,5e3,0),this.dirLight.position.set(-1e3,1e4,1e4),this.scene.add(this.dirLight),this.scene.add(new F(this.dirLight)),this._stats.dom.style.left="",this._stats.dom.style.top="",this._stats.dom.style.right="0px",this._stats.dom.style.bottom="0px",this._stats.dom.style.zIndex="100",t.appendChild(this._stats.dom),this.controls=this.createControls(e),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this.animate()}createControls(t){const e=new V(this.camera,this.container);return e.domElement=this.container,e.target.set(t.x,t.y,3),e.minDistance=.1,e.maxDistance=100,e.zoomSpeed=3,e.minPolarAngle=1,e.maxPolarAngle=1.4,e.enableDamping=!0,e.listenToKeyEvents(window),e.addEventListener("change",()=>{const o=Math.max(e.getPolarAngle(),.2),r=Math.max(e.getDistance(),1);e.zoomSpeed=Math.max(Math.log(r),1.2),this.scene.fog instanceof x&&(this.scene.fog.density=o/r/4),this.camera.far=Math.min(r/o*8,6e4),this.camera.near=Math.min(Math.max(this.camera.far/100,.1),1),this.camera.updateProjectionMatrix()}),e}resize(){const t=this.container.clientWidth,e=this.container.clientHeight;return this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t,e),this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this}animate(){this.controls.update(),this._stats.update(),this.renderer.render(this.scene,this.camera);const t=this._clock.getDelta();this.dispatchEvent({type:"update",delta:t}),requestAnimationFrame(this.animate.bind(this))}}const d=X(U,G),H=document.querySelector("#map"),l=d.geo2pos(new b(94.8,29.6)),a=new Y(H,new b(l.x,l.y,8));a.scene.add(d);const w=(()=>{const i=new M().load("../image/rain.png");i.rotation=.2;const s=new I({size:10,map:i,transparent:!0,depthTest:!1,fog:!1,sizeAttenuation:!1}),t=[],e=new R,o=5e3;for(let g=0;g<o;g++)t.push(0),t.push(0),t.push(-Math.random()*10);e.setAttribute("position",new k(t,3));const r=new B(e,s);return r.renderOrder=10,r.userData.speed=25,a.scene.add(r),d.addEventListener("update",g=>{if(a.rain){const h=e.attributes.position;for(let c=0;c<h.count;c++)h.getZ(c)<0?h.setXYZ(c,l.x+Math.random()*100-50,l.y+Math.random()*100-80,Math.random()*30):h.setXYZ(c,h.getX(c)+.1,h.getY(c),h.getZ(c)-g.delta*r.userData.speed);e.attributes.position.needsUpdate=!0}}),r})();(()=>{const i=new M().load("../image/thunder.png");i.colorSpace=T;const s=new j(new O({map:i,fog:!1,depthTest:!1}));s.position.set(l.x,l.y+30,15),s.scale.setScalar(20),a.scene.add(s),d.addEventListener("update",t=>{var e;if(a.flash){let o=new u(4386);s.visible=!1,a.ambLight.intensity=.1,a.dirLight.intensity=.1,Math.round(Math.random()*10)%20===0&&(o=new u(8806),s.position.setX(l.x+Math.random()*100-50),s.visible=!0,a.ambLight.intensity=1,a.dirLight.intensity=1),(e=a.scene.fog)==null||e.color.set(o),a.scene.background=new u(o)}})})();const L=new v,m=L.addFolder("地图控制");m.add(d.scale,"z",1,10,.1).name("高度拉伸倍数");m.add(d.position,"z",-1,1,.01).name("高度偏移");m.add(a.controls,"minPolarAngle",Math.PI/4,Math.PI/2,.1).name("最小倾角限制");m.add(a.controls,"maxPolarAngle",Math.PI/4,Math.PI/2,.1).name("最大倾角限制");m.add(a.controls,"enableDamping").name("惯性控制");m.add(a.controls,"autoRotate").name("自动旋转");m.add(d,"reload").name("重建瓦片树");const p=L.addFolder("环境设置");p.addColor(a.ambLight,"color").name("环境光颜色");p.addColor(a.dirLight,"color").name("直射光光颜色");p.add(a,"flash").name("闪电特效");p.add(a,"rain").name("下雨特效").onChange(i=>w.visible=i);p.add(w.material,"size",5,20,.1).name("雨滴大小");p.add(w.userData,"speed",2,100,1).name("雨滴速度");Z(d);q(a,d);
