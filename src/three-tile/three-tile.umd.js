(function(d,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],a):(d=typeof globalThis<"u"?globalThis:d||self,a(d.tt={},d.THREE))})(this,function(d,a){"use strict";var $t=Object.defineProperty;var Bt=(d,a,S)=>a in d?$t(d,a,{enumerable:!0,configurable:!0,writable:!0,value:S}):d[a]=S;var s=(d,a,S)=>(Bt(d,typeof a!="symbol"?a+"":a,S),S);function S(c,r,t,e,n){const o=new F(c,r,t);return o.position.copy(e),o.scale.copy(n),o.updateMatrix(),o}function qe(c,r=!1){if(c.isLeaf){const t=c.level+1,e=c.x*2,n=0,o=1/4;if(c.level===0&&r){const l=c.y,u=new a.Vector3(.5,1,1);c.add(S(t,e,l,new a.Vector3(-o,0,n),u)),c.add(S(t,e+1,l,new a.Vector3(o,0,n),u))}else{const l=c.y*2,u=new a.Vector3(.5,.5,1);c.add(S(t,e,l+1,new a.Vector3(-o,-o,n),u)),c.add(S(t,e+1,l+1,new a.Vector3(o,-o,n),u)),c.add(S(t,e,l,new a.Vector3(-o,o,n),u)),c.add(S(t,e+1,l,new a.Vector3(o,o,n),u))}}else console.error("重复创建子瓦片");return c.children}const pe=1,fe=new a.Vector3;function Qe(c,r){const t=c.position.clone(),e=c.geometry.userData.avg||1;t.setZ(e),t.applyMatrix4(c.matrixWorld);let n=r.getWorldPosition(fe).distanceTo(t);const o=fe.setFromMatrixScale(c.matrixWorld),l=Math.hypot(o.x,o.y);return n/l}var ee=(c=>(c[c.none=0]="none",c[c.create=1]="create",c[c.remove=2]="remove",c))(ee||{});function Je(c,r,t,e){const n=Qe(c,r);if((c.level<t||n<pe)&&c.level<e&&c.isLeafInFrustum)return 1;const o=pe+1.5+c.level/10;return(c.level>e||n>o)&&c.level>t&&c.index===0?2:0}const te=new a.PlaneGeometry,X=new a.MeshBasicMaterial({visible:!1,transparent:!0});class F extends a.Mesh{constructor(t=0,e=0,n=0){super(te,[X]);s(this,"level");s(this,"x");s(this,"y");s(this,"parent",null);s(this,"children",[]);s(this,"_loadedTime",Date.now());s(this,"_loadState","empty");s(this,"_toLoad",!1);s(this,"_inFrustum",!1);this.level=t,this.x=e,this.y=n,this.name=`Tile: ${this.level}-${this.x}-${this.y}`,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}get index(){return this.parent?this.parent.children.indexOf(this):-1}get loadState(){return this._loadState}get needLoad(){return this.inFrustum&&this._toLoad&&this.loadState==="empty"}get inFrustum(){return this._inFrustum}set inFrustum(t){this._inFrustum!=t&&(t?this._toLoad=this.isLeaf:Date.now()-this._loadedTime>1e3&&this.dispose(!0),this._inFrustum=t)}get isLeafInFrustum(){return this.inFrustum&&this.isLeaf}set temp(t){this.loadState!="empty"&&this.material.forEach(e=>{e.wireframe=t||e.userData.wireframe})}get isLeaf(){return this.children.length===0}get showing(){return this.material.some(t=>t.visible)}set showing(t){this.material.forEach(e=>{e!=X&&(e.visible=t)})}traverse(t){t(this),this.children.forEach(e=>{e.traverse(t)})}raycast(t,e){this.loadState==="loaded"&&super.raycast(t,e)}_reload(){return this.dispose(!1),this._toLoad=this.isLeaf||this.loadState!="empty",this}_lod(t,e,n,o){let l=null;if(!this.inFrustum)return l;const u=Je(this,t,e,n);if(u===ee.create)this._toLoad=!1,l=qe(this,o);else if(u===ee.remove&&this.loadState!="loading"){const h=this.parent;h instanceof F&&!h._toLoad&&(h._toLoad=!0,l=[])}return l}_load(t){return new Promise((e,n)=>{this.needLoad?(this._loadedTime=Date.now(),this._loadState="loading",t.load(this,o=>e(this._onLoad(o)))):e(!1)})}_onLoad(t){return this.parent?this.loadState==="empty"?(this._toLoad=!1,!1):(this.material.forEach(e=>{e.userData.wireframe=e.wireframe}),this.temp=this._hasLoadedParent(),this._loadState="loaded",!this.isLeaf&&this._toLoad&&(this.children.forEach(e=>e.dispose(!0)),this.clear(),this.temp=!1),this._toLoad=!1,!0):(this.dispose(!0),!1)}_hasLoadedParent(){const t=this.parent;return t instanceof F?t.loadState==="loaded"?!0:t._hasLoadedParent():!1}dispose(t){return this.loadState==="loading"&&this.dispatchEvent({type:"abort"}),this._toLoad=!1,this._loadState="empty",this.material.forEach(e=>{e!=X&&(e.dispose(),e=X)}),this.geometry!=te&&(this.geometry.dispose(),this.geometry.groups=[],this.geometry=te),this.dispatchEvent({type:"dispose"}),t&&(this.children.forEach(e=>{e.dispose(t),e.clear()}),this.clear()),this}}const Z=.6,et=new a.Box3(new a.Vector3(-Z,-Z,0),new a.Vector3(Z,Z,8)),tt=new a.Matrix4,ge=new a.Frustum;class ne extends F{constructor(t,e=0,n=0,o=0){super(e,n,o);s(this,"_treeReadyCount",0);s(this,"_updateDataEnable",!0);s(this,"_loader");s(this,"_minLevel",0);s(this,"_maxLevel",18);s(this,"isWGS",!1);this._loader=t,this.matrixAutoUpdate=!0,this.matrixWorldAutoUpdate=!0}get minLevel(){return this._minLevel}set minLevel(t){this._minLevel=t}get maxLevel(){return this._maxLevel}set maxLevel(t){this._maxLevel=t}get loader(){return this._loader}set loader(t){this._loader=t}get updateDataEnable(){return this._updateDataEnable&&this._treeReadyCount>20}set updateDataEnable(t){this._updateDataEnable=t}update(t){return this._updateTileTree(t)||this._treeReadyCount++,this.updateDataEnable&&(this._updateTileData(),this._treeReadyCount=0),this}reload(){return this.traverse(t=>t._reload()),this}_updateTileTree(t){let e=!1;return ge.setFromProjectionMatrix(tt.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)),this.traverse(n=>{const o=n._lod(t,this.minLevel,this.maxLevel,this.isWGS);e=!!o,o==null||o.forEach(l=>{this.dispatchEvent({type:"created",tile:l})}),n.inFrustum=ge.intersectsBox(et.clone().applyMatrix4(n.matrixWorld))}),e}_updateTileData(){return this.traverse(t=>{t._load(this.loader).then(e=>{e&&(this.dispatchEvent({type:"loaded",tile:t}),this._checkTileTree())})}),this}_checkTileTree(){const t=[];this.traverse(o=>t.push(o));const n=t.filter(o=>o.isLeafInFrustum).every(o=>o.loadState==="loaded");return n&&t.filter(o=>o.inFrustum).forEach(o=>{o.isLeaf?(this.dispatchEvent({type:"tile-show",child:o}),o.temp=!1):o.dispose(!1)}),n}}const nt=`\r
// #define LAMBERT\r
\r
uniform vec3 diffuse;\r
uniform vec3 emissive;\r
uniform float opacity;\r
\r
uniform sampler2D map;\r
uniform sampler2D map1;\r
\r
varying vec2 vUv;\r
\r
#include <common>\r
#include <packing>\r
#include <dithering_pars_fragment>\r
#include <color_pars_fragment>\r
#include <uv_pars_fragment>\r
#include <map_pars_fragment>\r
#include <alphamap_pars_fragment>\r
#include <alphatest_pars_fragment>\r
#include <aomap_pars_fragment>\r
#include <lightmap_pars_fragment>\r
#include <emissivemap_pars_fragment>\r
#include <envmap_common_pars_fragment>\r
#include <envmap_pars_fragment>\r
#include <fog_pars_fragment>\r
#include <bsdfs>\r
#include <lights_pars_begin>\r
#include <normal_pars_fragment>\r
#include <lights_lambert_pars_fragment>\r
#include <shadowmap_pars_fragment>\r
#include <bumpmap_pars_fragment>\r
#include <normalmap_pars_fragment>\r
#include <specularmap_pars_fragment>\r
#include <logdepthbuf_pars_fragment>\r
#include <clipping_planes_pars_fragment>\r
\r
void main() {\r
\r
	#include <clipping_planes_fragment>\r
\r
	vec4 diffuseColor = vec4( diffuse, opacity );\r
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\r
	vec3 totalEmissiveRadiance = emissive;\r
\r
	#include <logdepthbuf_fragment>\r
	#include <map_fragment>\r
	#include <color_fragment>\r
	#include <alphamap_fragment>\r
	\r
	\r
	#include <alphatest_fragment>\r
	#include <specularmap_fragment>\r
	#include <normal_fragment_begin>\r
	#include <normal_fragment_maps>\r
	#include <emissivemap_fragment>\r
\r
\r
	// 增加多图层混合\r
    diffuseColor *= texture2D( map, vUv );\r
	vec4 map1Color = texture2D(map1, vUv);\r
	diffuseColor.rgb = diffuseColor.rgb * (1.0 - map1Color.a) + map1Color.rgb * map1Color.a;\r
    diffuseColor.a = opacity;\r
    \r
	// 未加载纹理图片时显示白色（网格）\r
	vec2 size = vec2(textureSize(map, 0));\r
	if(size.x<2.0){\r
		diffuseColor = vec4(1.0, 1.0, 1.0, 0.3);		\r
	}\r
\r
	// accumulation\r
	#include <lights_lambert_fragment>\r
	#include <lights_fragment_begin>\r
	#include <lights_fragment_maps>\r
	#include <lights_fragment_end>\r
\r
	// modulation\r
	// #include <aomap_fragment>\r
\r
\r
\r
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\r
\r
	#include <envmap_fragment>\r
	#include <output_fragment>\r
	#include <tonemapping_fragment>\r
	#include <encodings_fragment>\r
	#include <fog_fragment>\r
	#include <premultiplied_alpha_fragment>\r
	#include <dithering_fragment>\r
\r
}`,ot=`\r
#define LAMBERT\r
\r
varying vec3 vViewPosition;\r
varying vec2 vUv;\r
\r
#include <common>\r
#include <uv_pars_vertex>\r
#include <displacementmap_pars_vertex>\r
#include <envmap_pars_vertex>\r
#include <color_pars_vertex>\r
#include <fog_pars_vertex>\r
#include <normal_pars_vertex>\r
#include <morphtarget_pars_vertex>\r
#include <skinning_pars_vertex>\r
#include <shadowmap_pars_vertex>\r
#include <logdepthbuf_pars_vertex>\r
#include <clipping_planes_pars_vertex>\r
\r
void main() {\r
\r
	#include <uv_vertex>\r
\r
	vUv = vec3( uv, 1 ).xy;\r
\r
	#include <color_vertex>\r
	#include <morphcolor_vertex>\r
\r
	#include <beginnormal_vertex>\r
	#include <morphnormal_vertex>\r
	#include <skinbase_vertex>\r
	#include <skinnormal_vertex>\r
	#include <defaultnormal_vertex>\r
	#include <normal_vertex>\r
\r
	#include <begin_vertex>\r
	#include <morphtarget_vertex>\r
	#include <skinning_vertex>\r
	#include <displacementmap_vertex>\r
\r
	// 增加dem数据\r
	#ifdef USE_DISPLACEMENTMAP\r
		vec4 heightColor = texture2D(displacementMap, vUv);\r
		// mapBox高程\r
		float h = ((heightColor.r * 255.0 * 65536.0 + heightColor.g * 255.0 * 256.0 + heightColor.b * 255.0) * 0.1)*heightColor.a - 10000.0;\r
		transformed += normalize( objectNormal ) * h / 1000.0;\r
	#endif\r
\r
\r
	#include <project_vertex>\r
	#include <logdepthbuf_vertex>\r
	#include <clipping_planes_vertex>\r
\r
	vViewPosition = - mvPosition.xyz;\r
\r
	#include <worldpos_vertex>\r
	#include <envmap_vertex>\r
	#include <shadowmap_vertex>\r
	#include <fog_vertex>\r
\r
}`;class rt extends a.ShaderMaterial{constructor(r){super({uniforms:a.UniformsUtils.merge([a.ShaderLib.lambert.uniforms,{map1:{value:null},diffuse:{value:new a.Color(16777215)}}]),vertexShader:ot,fragmentShader:nt,lights:!0,transparent:r.transparent||!0,wireframe:r.wireframe||!1,fog:!0}),this.uniforms.map.value=r.map,this.uniforms.map1.value=r.map1,this.defineProperty("map1"),this.defineProperty("diffuse"),this.defineProperty("opacity")}dispose(){var r,t;(r=this.uniforms.map.value)==null||r.dispose(),(t=this.uniforms.map1.value)==null||t.dispose(),super.dispose()}defineProperty(r){Object.defineProperty(this,r,{get:function(){return this.uniforms[r].value},set:function(t){this.uniforms[r].value=t}})}}class oe extends a.BufferGeometry{constructor(){super(),this.copy(new a.PlaneGeometry)}build(r){this.dispose(),this.copy(new a.PlaneGeometry(1,1,r-1,r-1))}getZ(r,t){const e=r[t*4],n=r[t*4+1],o=r[t*4+2];return(((e<<16)+(n<<8)+o)*.1-1e4)/1e3}setDemData(r){const t=Math.sqrt(r.length/4);this.build(t);const e=this.getAttribute("position");let n=0;for(let o=0;o<e.count;o++){const l=this.getZ(r,o);e.setZ(o,l),n+=l}return this.userData.avg=n/(r.length/4),this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),e.needsUpdate=!0,this}}function K(c,r,t){return Math.max(r,Math.min(t,c))}class ye extends oe{constructor(){super(...arguments);s(this,"type","TileRGBGeometry")}build(t){this.dispose();const e=1,n=1,o=t-1,l=t-1,u=e/2,h=n/2;let g=Math.floor(o),p=Math.floor(l);const b=e/g,y=n/p;g+=2,p+=2;const L=g+1,M=p+1,P=[],O=[],C=[],R=[];for(let _=0;_<M;_++)for(let T=0;T<L;T++){let f=0;(_===0||_===M-1||T===0||T===L-1)&&(f=-1);let D=(T-1)*b-u,V=(_-1)*y-h,j=(T-1)/(g-2),k=1-(_-1)/(p-2);D=K(D,-.5,.5),V=K(V,-.5,.5),j=K(j,0,1),k=K(k,0,1),O.push(D,-V,f),C.push(0,0,1),R.push(j,k)}for(let _=0;_<p;_++)for(let T=0;T<g;T++){const f=T+L*_,D=T+L*(_+1),V=T+1+L*(_+1),j=T+1+L*_;P.push(f,D,j),P.push(D,V,j)}this.setIndex(P),this.setAttribute("position",new a.Float32BufferAttribute(O,3)),this.setAttribute("normal",new a.Float32BufferAttribute(C,3)),this.setAttribute("uv",new a.Float32BufferAttribute(R,2))}setDemData(t){const e=Math.sqrt(t.length/4);this.build(e);const n=this.attributes.position;let o=0,l=0;for(let u=0;u<n.count;u++)if(n.getZ(u)===0){const h=this.getZ(t,o);n.setZ(u,h),l+=h,o++}else n.setZ(u,-1.5);return this.userData.avg=l/(t.length/4),this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),n.needsUpdate=!0,this}computeVertexNormals(){super.computeVertexNormals();const t=this.index,e=this.getAttribute("position");let n=this.getAttribute("normal");const o=new a.Vector3,l=new a.Vector3,u=new a.Vector3,h=new a.Vector3(0,0,1);function g(p){return n.setXYZ(p,h.x,h.y,h.z)}if(t)for(let p=0,b=t.count;p<b;p+=3){const y=t.getX(p+0),L=t.getX(p+1),M=t.getX(p+2);o.fromBufferAttribute(e,y),l.fromBufferAttribute(e,L),u.fromBufferAttribute(e,M),(o.z<-.1||l.z<-.1||u.z<-.1)&&(g(y),g(L),g(M))}n.needsUpdate=!0}}class it extends oe{build(r){this.dispose();const t=(r+1)/r;this.copy(new a.PlaneGeometry(t,t,r-1,r-1))}setDemData(r){const t=Math.sqrt(r.length/4);this.build(t);const e=this.attributes.position;let n=0;for(let o=0;o<e.count;o++){const l=this.getZ(r,o);e.setZ(o,l),this.userData._avg=n/(r.length/4)}return this.userData._avg=n/e.count,this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),e.needsUpdate=!0,this}}class re extends a.Loader{load(r,t,e,n,o){this.path!==void 0&&(r=this.path+r),r=this.manager.resolveURL(r);const l=a.Cache.get(r);if(l!==void 0)return this.manager.itemStart(r),setTimeout(()=>{t&&t(l),this.manager.itemEnd(r)},0),l;const u=new Image,h=y=>{p(),y.target instanceof HTMLImageElement&&(a.Cache.add(r,y.target),t&&t(y.target)),this.manager.itemEnd(r)},g=y=>{p(),n&&n(y),this.manager.itemError(r),this.manager.itemEnd(r)},p=()=>{u.removeEventListener("load",h,!1),u.removeEventListener("error",g,!1)};u.addEventListener("load",h,!1),u.addEventListener("error",g,!1);const b={};return b.credentials=this.crossOrigin==="anonymous"?"same-origin":"include",b.headers=this.requestHeader,b.signal=o,fetch(r,b).then(y=>{if(!y.ok)throw`tile load error: ${y.statusText}!`;return y.blob()}).then(y=>{u.src=URL.createObjectURL(y)}).catch(y=>{y.name==="AbortError"?console.log("download abort"):(console.error(`Download tile error: ${y}!`,r),this.manager.itemError(r)),this.manager.itemEnd(r),p(),n&&n(y)}),this.manager.itemStart(r),u}}function ie(c){const r=new AbortController,t=()=>r.abort();return c.addEventListener("abort",()=>{t(),c.removeEventListener("abort",t)}),r}const $=class{static registerTextureLoader(r){$.imgLoaderMap.set(r.dataType,r),console.log(`* image Loader: ${r.dataType}`)}static registerGeometryLoader(r){$.demLoaderMap.set(r.dataType,r),console.log(`* terrain Loader: ${r.dataType}`)}static getTextureLoader(r){const t=$.imgLoaderMap.get(r.dataType);if(t)return t;throw`${r.constructor.name}.dataType:${r.dataType} is not support!`}static getGeometryLoader(r){const t=$.demLoaderMap.get(r.dataType);if(t)return t;throw`${r.constructor.name}.dataType:${r.dataType} is not support!`}};let x=$;s(x,"manager",a.DefaultLoadingManager),s(x,"demLoaderMap",new Map),s(x,"imgLoaderMap",new Map);const q=class extends a.Loader{constructor(t,e,n=0){super(new a.LoadingManager);s(this,"projectCenterLon",0);s(this,"_showLoading",!0);s(this,"_imgSource");s(this,"_demSource");this.imgSource=t,this.demSource=e,this.projectCenterLon=n}get showLoading(){return this._showLoading}set showLoading(t){this._showLoading=t}get imgSource(){return this._imgSource}set imgSource(t){t&&t.length>2&&console.warn("supports only tow images provider on map"),this._imgSource=t}get demSource(){return this._demSource}set demSource(t){this._demSource=t}load(t,e){const n=()=>{if(o&&l){const g=h.findIndex(p=>p===q.tempMaterail);g>=0&&h.splice(g,1),u.groups=[];for(let p=0;p<h.length;p++)h[p].visible=!0,u.addGroup(0,1/0,p);e({geometry:u,material:h})}};let o=!1,l=!1;const u=this.loadGeometry(t,g=>{o=!0,n()}),h=this.loadMaterial(t,g=>{l=!0,n()});return this.showLoading&&(h.push(q.tempMaterail),u.addGroup(0,1/0,0)),t.geometry=u,t.material=h,{geometry:u,material:h}}loadGeometry(t,e){if(this.demSource)return x.getGeometryLoader(this.demSource).load(t,this.demSource,this.projectCenterLon,e);{const n=new a.PlaneGeometry;return setTimeout(()=>e(n),1),n}}loadMaterial(t,e){if(this.imgSource.length===0)throw new Error("no imgProvide!");const n=[];for(let l=0;l<this.imgSource.length;l++){const u=this.imgSource[l],h=x.getTextureLoader(u),g=new Promise((p,b)=>{h.load(t,u,this.projectCenterLon,y=>p(y))});n.push(g)}const o=[];return Promise.all(n).then(l=>{l.forEach(u=>{u.needsUpdate=!0;const h=new a.MeshLambertMaterial({map:u,transparent:!0});h.addEventListener("dispose",()=>{u.image instanceof ImageBitmap&&u.image.close(),u.dispose()}),o.push(h)}),e(o)}),o}};let N=q;s(N,"tempMaterail",new a.MeshBasicMaterial({wireframe:!0,color:3355443}));class at extends N{loadMaterial(r,t){const e=new a.MeshBasicMaterial({wireframe:!0,color:13421772});return setTimeout(()=>t([e]),1),[e]}}function be(c,r,t){const n=new OffscreenCanvas(r,r).getContext("2d");n.imageSmoothingEnabled=!1;const o=c.width;t.translate(new a.Vector2(.5,.5));const l=Math.floor(t.min.x*o),u=Math.floor(t.min.y*o),h=Math.floor((t.max.x-t.min.x)*o),g=Math.floor((t.max.y-t.min.y)*o);return n.drawImage(c,l,u,h,g,0,0,r,r),n.getImageData(0,0,r,r).data}function ae(c,r,t,e,n){function o(u,h,g){const p=Math.pow(2,h);let b=u+Math.round(p/360*g);return b>=p?b-=p:b<0&&(b+=p),b}const l=o(r,e,n);return c.getUrl(l,t,e)}function _e(c,r,t){const n=new OffscreenCanvas(256,256),o=n.getContext("2d");return o.scale(1,-1),o.translate(0,-256),o&&(o.strokeStyle="#ccc",o.lineWidth=4,o.strokeRect(5,5,256-10,256-10),o.fillStyle="white",o.shadowColor="black",o.shadowBlur=5,o.shadowOffsetX=1,o.shadowOffsetY=1,o.font="bold 20px arial",o.textAlign="center",o.fillText(`Tile Test - level: ${t}`,256/2,50),o.fillText(`[${c}, ${r}]`,256/2,80)),n.transferToImageBitmap()}const Te=new a.Texture;class ve{constructor(){s(this,"dataType","image");s(this,"name","Image map loader");s(this,"loader",new re(x.manager))}load(r,t,e,n){const o=ae(t,r.x,r.y,r.level,e);if(!o)return setTimeout(()=>n(Te),1),Te;const l=new a.Texture;return l.image=this.loader.load(o,u=>{l.colorSpace=t.colorSpace,n(l)},void 0,u=>n(l),ie(r).signal),l}}x.registerTextureLoader(new ve);const Le=new a.BufferGeometry;class we extends a.Loader{constructor(){super(...arguments);s(this,"dataType","mapbox-rgb");s(this,"name","MapboxTerrainRGB v1.0  loader");s(this,"imageLoader",new re(x.manager))}load(t,e,n,o){const{url:l,rect:u}=this.getUrl(t,e,n);if(!l)return setTimeout(()=>o(Le),1),Le;let h=(t.level+1)*2;h=Math.min(h,32);const g=new ye;return this.imageLoader.load(l,p=>{const b=be(p,h,u);g.setDemData(b),o(g)},void 0,p=>{o(g)},ie(t).signal),g}getUrl(t,e,n){const o=this._getMaxLevelTileAndRect(t,e.maxLevel||18);return{url:ae(e,o.tile.x,o.tile.y,o.tile.level,n),rect:o.box}}_getMaxLevelTileAndRect(t,e){let n=new a.Vector3,o=new a.Vector2(1,1);for(;t.level>e;)n.applyMatrix4(t.matrix),o.multiplyScalar(.5),t=t.parent;n.setY(-n.y);let l=new a.Box2().setFromCenterAndSize(new a.Vector2(n.x,n.y),o);return{tile:t,box:l}}}x.registerGeometryLoader(new we);class xe{constructor(){s(this,"dataType","test");s(this,"name","Test image loader")}load(r,t,e,n){const o=_e(r.x,r.y,r.level);let l=new a.CanvasTexture(o);return this._listenDispose(r,l),setTimeout(()=>n(l),1),l}_listenDispose(r,t){const e=()=>{t.image instanceof ImageBitmap&&t.image.close(),t.dispose()};r.addEventListener("dispose",()=>{e()})}}x.registerTextureLoader(new xe);class st extends N{loadMaterial(r,t){const e=[new a.MeshBasicMaterial({wireframe:!0})];return setTimeout(()=>t(e),1),e}}class I{constructor(r=0){s(this,"centerLon",0);s(this,"isWGS",!1);this.centerLon=r}static createFromID(r="3857",t=0){let e;switch(r){case"3857":e=new Y(t);break;case"4326":e=new Se(t);break}return e}static createFromSource(r,t=0){let e="3857";return r&&(e=(Array.isArray(r)?r[0].projection:r.projection)||"3857"),I.createFromID(e,t)}}const Ee=6378,H=class extends I{constructor(){super(...arguments);s(this,"ID","3857");s(this,"isWGS",!1);s(this,"mapWidth",2*Math.PI*Ee);s(this,"mapHeight",this.mapWidth);s(this,"mapDepth",1)}project(t,e){let n=t*Math.PI/180*H.earthRad;n-=this._getOffsetX();let o=e*Math.PI/180;const l=Math.sin(o);return o=H.earthRad/2*Math.log((1+l)/(1-l)),{x:n,y:o}}unProject(t,e){t+=this._getOffsetX();const n=H.earthRad*Math.PI;let o=t/n*180,l=e/n*180;return l=180/Math.PI*(2*Math.atan(Math.exp(l*Math.PI/180))-Math.PI/2),{lon:o,lat:l}}_getOffsetX(){return this.mapWidth/360*this.centerLon}};let Y=H;s(Y,"earthRad",Ee);class Se extends I{constructor(){super(...arguments);s(this,"ID","4326");s(this,"isWGS",!0);s(this,"mapWidth",36e3);s(this,"mapHeight",18e3);s(this,"mapDepth",1)}project(t,e){return{x:(t-this.centerLon)*100,y:e*100}}unProject(t,e){return{lon:t/100+this.centerLon,lat:e/100}}}function Me(c,r){const t=r.intersectObjects([c.rootTile]);for(const e of t)if(e.object instanceof F){const n=e.point.applyMatrix4(c.matrixWorld.clone().invert()),o=c.unProject(n.x,n.y);return Object.assign(e,{location:new a.Vector3(o.lon,o.lat,n.z)})}return null}function Pe(c,r){const t=new a.Vector3(r.x,r.y,100),e=new a.Raycaster(t,new a.Vector3(0,0,-1));return Me(c,e)}function ct(c,r,t){const e=new a.Raycaster;return e.setFromCamera(t,c),Me(r,e)}class se extends a.Mesh{constructor(t){super();s(this,"_clock",new a.Clock);s(this,"isLOD",!0);s(this,"autoUpdate",!0);s(this,"rootTile");s(this,"loader");s(this,"_projection");this.loader=t.loader,this.rootTile=t.rootTile||new ne(this.loader),this.rootTile.minLevel=t.minLevel||0,this.rootTile.maxLevel=t.maxLevel||18,this.projection=I.createFromSource(this.loader.imgSource,t.projCenterLon),this.loader.projectCenterLon!=0&&this.rootTile.minLevel<1&&console.warn(`Map projection is ${this.loader.projectCenterLon}, minLevel must > 0`),this._attachEvent(),this.add(this.rootTile),this.rootTile.updateMatrix(),this.rootTile.updateMatrixWorld()}get loadeEnable(){return this.rootTile.updateDataEnable}set loadEnable(t){this.rootTile.updateDataEnable=t}get projection(){return this._projection}set projection(t){var n;const e=(n=this._projection)==null?void 0:n.ID;this._projection=t,this.loader.projectCenterLon=t.centerLon,this.rootTile.isWGS=this._projection.isWGS,this.rootTile.scale.set(this._projection.mapWidth,this._projection.mapHeight,this._projection.mapDepth),e&&e!=t.ID&&(this.rebuild(),console.log("Map Projection Changed:",t.ID),this.dispatchEvent({type:"projection-changed",projection:t}))}get imgSource(){return this.loader.imgSource}set imgSource(t){this.loader.imgSource=t?Array.isArray(t)?t:[t]:[],console.log(this.attributions);let e="3857";t&&(e=(Array.isArray(t)?t[0].projection:t.projection)||"3857"),this.projection=I.createFromID(e,this.projection.centerLon),this.dispatchEvent({type:"source-changed",source:t})}get demSource(){return this.loader.demSource}set demSource(t){this.loader.demSource=t,this.dispatchEvent({type:"source-changed",source:t})}static create(t){let e=t.imgSource;Array.isArray(e)||(e=[e]);const n=new N(e,t.demSource,t.projCenterLon),o=new ne(n,0,0,0);return new se({loader:n,rootTile:o,projCenterLon:t.projCenterLon,minLevel:t.minLevel,maxLevel:t.maxLevel})}update(t){this.rootTile.update(t),this.dispatchEvent({type:"update",delta:this._clock.getDelta()})}reload(){this.rootTile.reload()}rebuild(){this.rootTile.dispose(!0)}get attributions(){const t=[];let e=this.imgSource;if(e&&(Array.isArray(e)||(e=[e]),e.forEach(n=>{const o=n.attribution;o&&t.indexOf(o)<0&&t.push(o)})),this.demSource){const n=this.demSource.attribution;n&&t.indexOf(n)<0&&t.push(n)}return t}project(t,e){return this._projection.project(t,e)}unProject(t,e){return this._projection.unProject(t,e)}getLocalInfoFromLocation(t,e){const n=this.project(t,e);return Pe(this,new a.Vector2(n.x,n.y))}getLocalInfoFromWorld(t){return Pe(this,t)}getLocationFromScreen(t,e){return ct(t,this,e)}getTileCount(){let t=0,e=0,n=0,o=0;return this.rootTile.traverse(l=>{t++,l.isLeafInFrustum&&e++,l.isLeaf&&o++,n=Math.max(n,l.level)}),{sum:t,visible:e,leaf:o,maxLevle:n}}_attachEvent(){const t=x.manager;return t.onStart=(e,n,o)=>{this.dispatchEvent({type:"loading-start",itemsLoaded:n,itemsTotal:o})},t.onError=e=>{this.dispatchEvent({type:"loading-error",url:e})},t.onLoad=()=>{this.dispatchEvent({type:"loading-complete"})},t.onProgress=(e,n,o)=>{this.dispatchEvent({type:"loading-progress",url:e,itemsLoaded:n,itemsTotal:o})},this.rootTile.addEventListener("created",e=>{this.dispatchEvent({type:"tile-created",tile:e.tile})}),this.rootTile.addEventListener("loaded",e=>{this.dispatchEvent({type:"tile-loaded",tile:e.tile})}),this}}class E{constructor(r){s(this,"dataType","unknown");s(this,"attribution","ThreeTile");s(this,"minLevel",0);s(this,"maxLevel",18);s(this,"projection","3857");s(this,"urlTemplate","");s(this,"bounds",[-180,-85.05112877980659,-180,85.05112877980659]);s(this,"projectionBounds");s(this,"colorSpace",a.SRGBColorSpace);this.dataType=(r==null?void 0:r.dataType)||"unknown",this.attribution=(r==null?void 0:r.attribution)||"ThreeTile",this.projection=(r==null?void 0:r.projection)||"3857",(r==null?void 0:r.url)instanceof Function?this.getUrl=r.url:this.urlTemplate=r==null?void 0:r.url;const t=I.createFromID(this.projection).project(this.bounds[0],this.bounds[1]),e=I.createFromID(this.projection).project(this.bounds[2],this.bounds[3]);this.projectionBounds=[t.x,t.y,e.x,e.y]}getAxisBounds(r){const t=Math.pow(2,r),e=Math.pow(2,r);return{x:t,y:e}}getUrl(r,t,e){if(this.urlTemplate){const n=Object.assign({},this,{x:r,y:t,z:e});return De(this.urlTemplate,n)}}static create(r){return new E(r)}}function De(c,r){const t=/\{ *([\w_ -]+) *\}/g;return c.replace(t,(e,n)=>{let o=r[n];if(o===void 0)throw new Error(`No value provided for variable ${e}`);return typeof o=="function"&&(o=o(r)),o})}class je extends E{constructor(t,e){super(e);s(this,"token","");s(this,"format","webp");s(this,"style","mapbox.satellite");s(this,"attribution","MapBox");this.token=t}getUrl(t,e,n){return`https://api.mapbox.com/v4/${this.style}/${n}/${t}/${e}.${this.format}?access_token=${this.token}`}}class lt extends je{constructor(){super(...arguments);s(this,"style","mapbox.satellite");s(this,"dataType","image")}}class ut extends je{constructor(){super(...arguments);s(this,"style","mapbox.terrain-rgb");s(this,"dataType","mapbox-rgb")}}class dt extends E{constructor(t="s"){super();s(this,"dataType","image");s(this,"attribution","Google");s(this,"style");this.style=t}getUrl(t,e,n){return`https://gac-geo.googlecnapps.cn/maps/vt?lyrs=${this.style}&x=${t}&y=${e}&z=${n}`}}class mt extends E{constructor(t="A,RL"){super();s(this,"dataType","image");s(this,"attribution","bing地图[GS(2021)1731]");s(this,"style","A,RL");this.style=t}getUrl(t,e,n){return`https://t1.dynamic.tiles.ditu.live.com/comp/ch/${ht(n,t,e)}?mkt=zh-CN&ur=CN&it=${this.style}&n=z&og=804&cstl=vb`}}function ht(c,r,t){let e="";for(let n=c;n>0;n--){const o=1<<n-1;let l=0;r&o&&l++,t&o&&(l+=2),e+=l}return e}class pt extends E{constructor(t="World_Imagery"){super();s(this,"dataType","image");s(this,"attribution","ArcGIS");s(this,"style","World_Imagery");this.style=t}getUrl(t,e,n){return`https://services.arcgisonline.com/arcgis/rest/services/${this.style}/MapServer/tile/${n}/${e}/${t}`}}class ft extends E{constructor(t="8"){super();s(this,"dataType","image");s(this,"attribution","高德[GS(2021)6375号]");s(this,"style","8");this.style=t}getUrl(t,e,n){return`https://webst04.is.autonavi.com/appmaptile?style=${this.style}&x=${t}&y=${e}&z=${n}`}}class Ae extends E{constructor(t,e="img"){super();s(this,"attribution","中科星图[GS(2022)3995号]");s(this,"token","");s(this,"style","img");s(this,"format","webp");this.token=t,this.style=e}getUrl(t,e,n){return`https://tiles2.geovisearth.com/base/v1/${this.style}/${n}/${t}/${e}?format=${this.format}&tmsIds=w&token=${this.token}`}}class gt extends Ae{constructor(){super(...arguments);s(this,"dataType","image");s(this,"maxLevel",18);s(this,"format","webp")}}class yt extends Ae{constructor(){super(...arguments);s(this,"dataType","mapbox-rgb");s(this,"style","terrain_rgb");s(this,"maxLevel",10);s(this,"format","png")}}class ce extends E{constructor(t="get_your_own_key_QmavnBrQwNGsQ8YvPzZg",e="terrain-rgb",n="png"){super();s(this,"attribution","MapTiler");s(this,"token");s(this,"format");s(this,"style");this.token=t,this.format=n,this.style=e}getUrl(t,e,n){return`https://api.maptiler.com/tiles/${this.style}/${n}/${t}/${e}.${this.format}?key=${this.token}`}}class bt extends ce{constructor(){super(...arguments);s(this,"dataType","image");s(this,"format","jpg");s(this,"style","satellite-v2")}}class _t extends ce{constructor(){super(...arguments);s(this,"dataType","mapbox-rgb");s(this,"style","terrain-rgb-v2");s(this,"format","webp");s(this,"maxLevel",12)}}class Tt extends E{constructor(){super(...arguments);s(this,"dataType","image");s(this,"attribution","腾讯[GS(2023)1号]")}getUrl(t,e,n){const o=t>>4,l=(1<<n)-e>>4,u=Math.pow(2,n)-1-e;return`https://p0.map.gtimg.com/sateTiles/${n}/${o}/${l}/${t}_${u}.jpg`}}class Oe extends E{constructor(t,e="img_w"){super();s(this,"dataType","image");s(this,"attribution","天地图[GS(2023)336号]");s(this,"token","");s(this,"style");this.style=e,this.token=t}getUrl(t,e,n){const o=this.projection==="3857"?"w":"c";return`https://t0.tianditu.gov.cn/${this.style}/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=${o}&FORMAT=tiles&TILEMATRIX=${n}&TILEROW=${e}&TILECOL=${t}&tk=${this.token}`}}class vt extends Oe{constructor(){super(...arguments);s(this,"projection","4326")}}class Lt extends E{constructor(t="pl"){super();s(this,"dataType","image");s(this,"attribution","百度[GS(2021)6026号]");s(this,"style","pl");this.style=t}getUrl(t,e,n){return`https://online0.map.bdimg.com/tile/?qt=tile&x=${t}&y=${e}&z=${n}&v=020`}}const Ie={type:"change"},le={type:"start"},Ce={type:"end"};class wt extends a.EventDispatcher{constructor(r,t){super(),this.object=r,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new a.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:a.MOUSE.ROTATE,MIDDLE:a.MOUSE.DOLLY,RIGHT:a.MOUSE.PAN},this.touches={ONE:a.TOUCH.ROTATE,TWO:a.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return u.phi},this.getAzimuthalAngle=function(){return u.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(i){i.addEventListener("keydown",me),this._domElementKeyEvents=i},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",me),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(Ie),e.update(),o=n.NONE},this.update=function(){const i=new a.Vector3,m=new a.Quaternion().setFromUnitVectors(r.up,new a.Vector3(0,1,0)),v=m.clone().invert(),w=new a.Vector3,A=new a.Quaternion,z=2*Math.PI;return function(){const Ke=e.object.position;i.copy(Ke).sub(e.target),i.applyQuaternion(m),u.setFromVector3(i),e.autoRotate&&o===n.NONE&&k(V()),e.enableDamping?(u.theta+=h.theta*e.dampingFactor,u.phi+=h.phi*e.dampingFactor):(u.theta+=h.theta,u.phi+=h.phi);let U=e.minAzimuthAngle,G=e.maxAzimuthAngle;return isFinite(U)&&isFinite(G)&&(U<-Math.PI?U+=z:U>Math.PI&&(U-=z),G<-Math.PI?G+=z:G>Math.PI&&(G-=z),U<=G?u.theta=Math.max(U,Math.min(G,u.theta)):u.theta=u.theta>(U+G)/2?Math.max(U,u.theta):Math.min(G,u.theta)),u.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,u.phi)),u.makeSafe(),u.radius*=g,u.radius=Math.max(e.minDistance,Math.min(e.maxDistance,u.radius)),e.enableDamping===!0?e.target.addScaledVector(p,e.dampingFactor):e.target.add(p),i.setFromSpherical(u),i.applyQuaternion(v),Ke.copy(e.target).add(i),e.object.lookAt(e.target),e.enableDamping===!0?(h.theta*=1-e.dampingFactor,h.phi*=1-e.dampingFactor,p.multiplyScalar(1-e.dampingFactor)):(h.set(0,0,0),p.set(0,0,0)),g=1,b||w.distanceToSquared(e.object.position)>l||8*(1-A.dot(e.object.quaternion))>l?(e.dispatchEvent(Ie),w.copy(e.object.position),A.copy(e.object.quaternion),b=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",Xe),e.domElement.removeEventListener("pointerdown",He),e.domElement.removeEventListener("pointercancel",W),e.domElement.removeEventListener("wheel",We),e.domElement.removeEventListener("pointermove",de),e.domElement.removeEventListener("pointerup",W),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",me),e._domElementKeyEvents=null)};const e=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=n.NONE;const l=1e-6,u=new a.Spherical,h=new a.Spherical;let g=1;const p=new a.Vector3;let b=!1;const y=new a.Vector2,L=new a.Vector2,M=new a.Vector2,P=new a.Vector2,O=new a.Vector2,C=new a.Vector2,R=new a.Vector2,_=new a.Vector2,T=new a.Vector2,f=[],D={};function V(){return 2*Math.PI/60/60*e.autoRotateSpeed}function j(){return Math.pow(.95,e.zoomSpeed)}function k(i){h.theta-=i}function Q(i){h.phi-=i}const Re=function(){const i=new a.Vector3;return function(v,w){i.setFromMatrixColumn(w,0),i.multiplyScalar(-v),p.add(i)}}(),ke=function(){const i=new a.Vector3;return function(v,w){e.screenSpacePanning===!0?i.setFromMatrixColumn(w,1):(i.setFromMatrixColumn(w,0),i.crossVectors(e.object.up,i)),i.multiplyScalar(v),p.add(i)}}(),B=function(){const i=new a.Vector3;return function(v,w){const A=e.domElement;if(e.object.isPerspectiveCamera){const z=e.object.position;i.copy(z).sub(e.target);let J=i.length();J*=Math.tan(e.object.fov/2*Math.PI/180),Re(2*v*J/A.clientHeight,e.object.matrix),ke(2*w*J/A.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(Re(v*(e.object.right-e.object.left)/e.object.zoom/A.clientWidth,e.object.matrix),ke(w*(e.object.top-e.object.bottom)/e.object.zoom/A.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function ue(i){e.object.isPerspectiveCamera?g/=i:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*i)),e.object.updateProjectionMatrix(),b=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Ue(i){e.object.isPerspectiveCamera?g*=i:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/i)),e.object.updateProjectionMatrix(),b=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Ge(i){y.set(i.clientX,i.clientY)}function St(i){R.set(i.clientX,i.clientY)}function Fe(i){P.set(i.clientX,i.clientY)}function Mt(i){L.set(i.clientX,i.clientY),M.subVectors(L,y).multiplyScalar(e.rotateSpeed);const m=e.domElement;k(2*Math.PI*M.x/m.clientHeight),Q(2*Math.PI*M.y/m.clientHeight),y.copy(L),e.update()}function Pt(i){_.set(i.clientX,i.clientY),T.subVectors(_,R),T.y>0?ue(j()):T.y<0&&Ue(j()),R.copy(_),e.update()}function Dt(i){O.set(i.clientX,i.clientY),C.subVectors(O,P).multiplyScalar(e.panSpeed),B(C.x,C.y),P.copy(O),e.update()}function jt(i){i.deltaY<0?Ue(j()):i.deltaY>0&&ue(j()),e.update()}function At(i){let m=!1;switch(i.code){case e.keys.UP:i.ctrlKey||i.metaKey||i.shiftKey?Q(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):B(0,e.keyPanSpeed),m=!0;break;case e.keys.BOTTOM:i.ctrlKey||i.metaKey||i.shiftKey?Q(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):B(0,-e.keyPanSpeed),m=!0;break;case e.keys.LEFT:i.ctrlKey||i.metaKey||i.shiftKey?k(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):B(e.keyPanSpeed,0),m=!0;break;case e.keys.RIGHT:i.ctrlKey||i.metaKey||i.shiftKey?k(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):B(-e.keyPanSpeed,0),m=!0;break}m&&(i.preventDefault(),e.update())}function Ne(){if(f.length===1)y.set(f[0].pageX,f[0].pageY);else{const i=.5*(f[0].pageX+f[1].pageX),m=.5*(f[0].pageY+f[1].pageY);y.set(i,m)}}function Ve(){if(f.length===1)P.set(f[0].pageX,f[0].pageY);else{const i=.5*(f[0].pageX+f[1].pageX),m=.5*(f[0].pageY+f[1].pageY);P.set(i,m)}}function $e(){const i=f[0].pageX-f[1].pageX,m=f[0].pageY-f[1].pageY,v=Math.sqrt(i*i+m*m);R.set(0,v)}function Ot(){e.enableZoom&&$e(),e.enablePan&&Ve()}function It(){e.enableZoom&&$e(),e.enableRotate&&Ne()}function Be(i){if(f.length==1)L.set(i.pageX,i.pageY);else{const v=he(i),w=.5*(i.pageX+v.x),A=.5*(i.pageY+v.y);L.set(w,A)}M.subVectors(L,y).multiplyScalar(e.rotateSpeed);const m=e.domElement;k(2*Math.PI*M.x/m.clientHeight),Q(2*Math.PI*M.y/m.clientHeight),y.copy(L)}function ze(i){if(f.length===1)O.set(i.pageX,i.pageY);else{const m=he(i),v=.5*(i.pageX+m.x),w=.5*(i.pageY+m.y);O.set(v,w)}C.subVectors(O,P).multiplyScalar(e.panSpeed),B(C.x,C.y),P.copy(O)}function Ye(i){const m=he(i),v=i.pageX-m.x,w=i.pageY-m.y,A=Math.sqrt(v*v+w*w);_.set(0,A),T.set(0,Math.pow(_.y/R.y,e.zoomSpeed)),ue(T.y),R.copy(_)}function Ct(i){e.enableZoom&&Ye(i),e.enablePan&&ze(i)}function Rt(i){e.enableZoom&&Ye(i),e.enableRotate&&Be(i)}function He(i){e.enabled!==!1&&(f.length===0&&(e.domElement.setPointerCapture(i.pointerId),e.domElement.addEventListener("pointermove",de),e.domElement.addEventListener("pointerup",W)),Nt(i),i.pointerType==="touch"?Gt(i):kt(i))}function de(i){e.enabled!==!1&&(i.pointerType==="touch"?Ft(i):Ut(i))}function W(i){Vt(i),f.length===0&&(e.domElement.releasePointerCapture(i.pointerId),e.domElement.removeEventListener("pointermove",de),e.domElement.removeEventListener("pointerup",W)),e.dispatchEvent(Ce),o=n.NONE}function kt(i){let m;switch(i.button){case 0:m=e.mouseButtons.LEFT;break;case 1:m=e.mouseButtons.MIDDLE;break;case 2:m=e.mouseButtons.RIGHT;break;default:m=-1}switch(m){case a.MOUSE.DOLLY:if(e.enableZoom===!1)return;St(i),o=n.DOLLY;break;case a.MOUSE.ROTATE:if(i.ctrlKey||i.metaKey||i.shiftKey){if(e.enablePan===!1)return;Fe(i),o=n.PAN}else{if(e.enableRotate===!1)return;Ge(i),o=n.ROTATE}break;case a.MOUSE.PAN:if(i.ctrlKey||i.metaKey||i.shiftKey){if(e.enableRotate===!1)return;Ge(i),o=n.ROTATE}else{if(e.enablePan===!1)return;Fe(i),o=n.PAN}break;default:o=n.NONE}o!==n.NONE&&e.dispatchEvent(le)}function Ut(i){switch(o){case n.ROTATE:if(e.enableRotate===!1)return;Mt(i);break;case n.DOLLY:if(e.enableZoom===!1)return;Pt(i);break;case n.PAN:if(e.enablePan===!1)return;Dt(i);break}}function We(i){e.enabled===!1||e.enableZoom===!1||o!==n.NONE||(i.preventDefault(),e.dispatchEvent(le),jt(i),e.dispatchEvent(Ce))}function me(i){e.enabled===!1||e.enablePan===!1||At(i)}function Gt(i){switch(Ze(i),f.length){case 1:switch(e.touches.ONE){case a.TOUCH.ROTATE:if(e.enableRotate===!1)return;Ne(),o=n.TOUCH_ROTATE;break;case a.TOUCH.PAN:if(e.enablePan===!1)return;Ve(),o=n.TOUCH_PAN;break;default:o=n.NONE}break;case 2:switch(e.touches.TWO){case a.TOUCH.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ot(),o=n.TOUCH_DOLLY_PAN;break;case a.TOUCH.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;It(),o=n.TOUCH_DOLLY_ROTATE;break;default:o=n.NONE}break;default:o=n.NONE}o!==n.NONE&&e.dispatchEvent(le)}function Ft(i){switch(Ze(i),o){case n.TOUCH_ROTATE:if(e.enableRotate===!1)return;Be(i),e.update();break;case n.TOUCH_PAN:if(e.enablePan===!1)return;ze(i),e.update();break;case n.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ct(i),e.update();break;case n.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Rt(i),e.update();break;default:o=n.NONE}}function Xe(i){e.enabled!==!1&&i.preventDefault()}function Nt(i){f.push(i)}function Vt(i){delete D[i.pointerId];for(let m=0;m<f.length;m++)if(f[m].pointerId==i.pointerId){f.splice(m,1);return}}function Ze(i){let m=D[i.pointerId];m===void 0&&(m=new a.Vector2,D[i.pointerId]=m),m.set(i.pageX,i.pageY)}function he(i){const m=i.pointerId===f[0].pointerId?f[1]:f[0];return D[m.pointerId]}e.domElement.addEventListener("contextmenu",Xe),e.domElement.addEventListener("pointerdown",He),e.domElement.addEventListener("pointercancel",W),e.domElement.addEventListener("wheel",We,{passive:!1}),this.update()}}class xt extends wt{constructor(r,t){super(r,t),this.screenSpacePanning=!1,this.mouseButtons={LEFT:a.MOUSE.PAN,MIDDLE:a.MOUSE.DOLLY,RIGHT:a.MOUSE.ROTATE},this.touches={ONE:a.TOUCH.PAN,TWO:a.TOUCH.DOLLY_ROTATE}}}a.Object3D.DEFAULT_UP.set(0,0,1);class Et extends a.EventDispatcher{constructor(t,e=new a.Vector3(0,3e3,0),n=new a.Vector3(0,-1e3,1e4)){super();s(this,"scene");s(this,"renderer");s(this,"camera");s(this,"controls");s(this,"ambLight");s(this,"dirLight");s(this,"container");s(this,"_clock",new a.Clock);s(this,"_fogFactor",1);this.container=t,this.renderer=this._createRenderer(),this.scene=this._createScene(),this.camera=this._createCamera(n),this.controls=this._createControls(e,this.camera,t),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this.animate()}get fogFactor(){return this._fogFactor}set fogFactor(t){this._fogFactor=t,this.controls.dispatchEvent({type:"change",target:this.controls})}_createDirLight(){const t=new a.DirectionalLight(16777215,.5);return t.target.position.copy(this.controls.target),t.position.set(-1e3,-2e3,1e4),t}_createAmbLight(){return new a.AmbientLight(16777215,.7)}_createControls(t,e,n){const o=new xt(e,n);return o.target.copy(t),o.minDistance=.1,o.maxDistance=15e3,o.zoomSpeed=3,o.maxPolarAngle=1.2,o.enableDamping=!0,o.listenToKeyEvents(window),o.addEventListener("change",()=>{const l=Math.max(this.controls.getPolarAngle(),.1),u=Math.max(this.controls.getDistance(),.1);o.zoomSpeed=Math.max(Math.log(u),1.8),this.camera.far=Math.max(Math.min(u/l*8,5e4),100),this.camera.near=this.camera.far/1e3,this.camera.updateProjectionMatrix(),this.scene.fog instanceof a.FogExp2&&(this.scene.fog.density=l/(u+5)/4*this.fogFactor)}),o.saveState(),o}_createCamera(t){const e=new a.PerspectiveCamera(80,1,.1,5e4);return e.position.copy(t),e}_createScene(){const e=new a.Scene;return e.background=new a.Color(14414079),e.fog=new a.FogExp2(14414079,0),e}_createRenderer(){const t=new a.WebGLRenderer({antialias:!0,alpha:!0,logarithmicDepthBuffer:!0,precision:"highp"});return t.sortObjects=!0,t.setPixelRatio(window.devicePixelRatio),t}resize(){const t=this.container.clientWidth,e=this.container.clientHeight;return this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t,e),this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this}animate(){this.renderer.render(this.scene,this.camera),this.controls.update(),this.dispatchEvent({type:"update",delta:this._clock.getDelta()}),requestAnimationFrame(this.animate.bind(this))}}d.AbortImageLoader=re,d.ArcGisSource=pt,d.BaiduSource=Lt,d.BingSource=mt,d.GDSource=ft,d.GLViewer=Et,d.GoogleSource=dt,d.LoaderFactory=x,d.MapBoxDemSource=ut,d.MapBoxImgSource=lt,d.MapTilerDemSource=_t,d.MapTilerImgSource=bt,d.MapTilerSource=ce,d.ProjMCT=Y,d.ProjWGS=Se,d.Projection=I,d.RootTile=ne,d.Source=E,d.TDTSource=Oe,d.TDTSourceC=vt,d.TXSource=Tt,d.TestLoader=at,d.Tile=F,d.TileDEMGeometry=it,d.TileGeometry=oe,d.TileGeometryLoader=we,d.TileLoader=N,d.TileMap=se,d.TileMaterial=rt,d.TileRGBGeometry=ye,d.TileTextureLoader=ve,d.TileTextureTestLoader=xe,d.WireframeLoader=st,d.ZKXTImgSource=gt,d.ZKXtDemSource=yt,d.drawTile=_e,d.getAbortController=ie,d.getImageData=be,d.getProjectionUrl=ae,d.strTemplate=De,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
